{% extends "base.html" %}
{% load i18n %}

{% load crispy_forms_tags %}
{% load django_markdown %}

{% load staticfiles %}
{% load country_isocode %}

{% block extra_js %}

  {% if request|get_country_by_ip != 'CN' %}
   <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
  {% else %}  
   <script src="{% static "cdn/jqueryui/1.11.2/jquery-ui.min.js" %}"></script>
  {% endif %}

  {% if request.user == object.user %}
  <script>
      $(function() {
          $( ".sortable" ).sortable({
              update: function(event, ui) {
                  var data = [];
                  $(".list-group-item").each(function() {
                      data.push({id: $(this).data("id"), index: $(this).index()});
                  });
                  $.ajax({
                      method: "POST",
                      url: "{% url 'change-step-priority' %}",
                      data: {"steps": JSON.stringify(data)}
                  });
              }
          });
          $( ".sortable" ).disableSelection();
      });
  </script>
  {% endif %}
  {% endblock extra_js %}

{% block title %}p: {{ object.name }}{% endblock title %}

{% block content %}

<script>
function showMore(){
    document.getElementById("stats").innerHTML = "<span onmouseout='showLess()'>[<u>assumed</u> {{ object.total_assumed|floatformat:2 }} h, <u>donated</u> {{ object.total_donated|floatformat:2 }} ħ, <u>claimed</u> {{ object.total_claimed|floatformat:2 }}, <u>matched</u> {{ object.total_matched|floatformat:2}} ḥ]</span>";
}

function showLess(){
    document.getElementById("stats").innerHTML = "<span onmouseover='showMore()'><b>[<u>{% trans "needs" %} ${{ object.get_remain_usd|floatformat:2 }} {% trans "for funding" %} {{ object.not_funded_hours|floatformat:2}} {% trans "hours" %}</u>]</b></span>";
}
</script>

<script>
$(document).ready( function() {
    $(".tiptext").mouseover(function() {
        $(this).children(".description").show();
    }).mouseout(function() {
        $(this).children(".description").hide();
    });
});
</script>

{% if object.personal %}
<style>
  body {
  background-color: #e0e0e0;
  }
  .panel {
  background-color: #f0f0f0;
  }
</style>
{% endif %}

<div class="panel panel-default box col-sm-12 col-md-7">
<div class="panel-body">
    <div class="alignleft"><a href="#id_name" onclick="getfocus()"><i class="fa fa-share"></i></a></div>

    <div class="alignright">
        <form style="text-align: right;" action="/subscribe/" method="post" accept-charset="utf-8">{% csrf_token %}
              <input type="hidden" value="{{ content_type }}" id="id_content_type" name="content_type">
              <input type="hidden" value="{{ object_id }}" id="id_object_id" name="object_id">
              <p><input type="submit" value="{% if is_subscribed %}{% trans "Unsubscribe" %}{% else %}{% trans "Subscribe" %}{% endif %}"></p> 
        </form>
    </div>
    <div style="clear:both;"></div>

    <div align="right" id="stats">
        <span onmouseover="showMore()"><b>[<u>{% trans "needs" %} ${{ object.get_remain_usd|floatformat:2 }} {% trans "for funding" %} {{ object.not_funded_hours|floatformat:2}} {% trans "hours" %}</u>]</b></span>
    </div>
    <div align="right">
        [<u>{% trans "members:" %}</u> {% for member in object.members.all %} <a href="{% url 'user-detail' member.username %}">{{ member.username }}</a>, {% endfor %} <!--<span class="tiptext"><u>{% trans "equity" %}</u>: {{ object.get_equity|floatformat:0 }}% ḥ-->]<br/>
            <div class="description" align="left">{% trans "A fixed percentage of all the future <b>ḥ</b> (<u>time and money spent</u>), which indicates how much project <u>shareholders</u> own of all results under this project. The rest is owned by contributing users." %}</div>
    </span>
    </div>

    {% trans "approach to realizing idea" %} <a href="{% url "idea-detail" object.idea.pk %}">
        
		  {% if object.idea.personal %}
		    {% if request.user in object.idea.sharewith or request.user == object.idea.user %}
		       {{ object.idea }}
		    {% else %}
               {% trans "private" %} {% trans "idea" %} (by {{ object.idea.user.username }})
			{% endif %}
		  {% else %}
		  {{ object.idea }}
		  {% endif %}
    
    </a><br/>
    {% trans "translations:" %}
    <!-- translations -->
    {% for translation in translations %}
    {% if translation.language.language_code %}
    <a href="{% url "plan-detail" object.id %}?lang={{translation.language.language_code }}">
        [{{ translation.language.language_code }}]
    </a>
    {% endif %}
    {% endfor %}
    <a href="{{ translate_url }}">[+]</a>
    <!-- /translations -->
    <h1>{% if not translation %}{{ object.name }}{% else %}{{ translation.name}}{% endif %}</h1>
    
    <div>
        {% if object.is_historical %}
            <span class="badge" style="background-color: brown;">{% trans "historical" %}</span>
            <br />
        {% endif %}
        {% if object.is_link %}
        <i><span style="color:grey;">{% trans "Source:" %} <a href="{{ object.url }}" style="color:grey;">{{ object.url }}</a>.</span></i>
        {% endif %}
    </div>

    {% if object.user == request.user %}[<a href="{% if not translation %}{% url "plan-update" object.pk %}{% else %}{% url "update-translation" translation.pk %}{% endif %}">{% trans "edit" %}</a>, <a href="{% if not translation %}{% url "plan-delete" object.pk %}{% else %}{% url "delete-translation" translation.pk %}{% endif %}">{% trans "delete" %}</a>]<br/>{% endif %}
<br/>

<center>{% trans "deliverable" %}</center>
<div class="breadcrumb">
    {% if not translation %}{{object.deliverable|markdown}}{% else %}{{translation.deliverable|markdown}}{% endif %}
</div>

<center>{% trans "situation" %}</center>
<div class="breadcrumb">
{% if not translation %}{{object.situation|markdown}}{% else %}{{translation.situation|markdown}}{% endif %}
</div>


<div id="step-list" align="right">--[<a href="{% url 'user-detail' object.user.username %}">{{object.user}}</a>], {{object.created_at}}</div>

{% if object.personal %}<i class="fa {% if object.user == request.user %}fa-lock{% else %}fa-flag{% endif %}"></i> [<u>{% trans "shared with:" %}</u> {% for member in object.sharewith.all %} <a href="{% url 'user-detail' member.username %}">{{ member.username }}</a>{%if not forloop.last%}, {%endif%}{% endfor %}]{% endif %}

</div>


<div class="panel-heading">{% trans "Steps" %}</div>
<div class="panel-body">
    <ul class="list-group sortable">
        {% for step in step_list %}
        <li id="{{ step.priority }}" data-id="{{ step.id }}" class="list-group-item{% if request.user == object.user %} cursor-move{%endif%}">
        {% if step.is_link %}
        <span class="badge">{% trans "link" %}</span>
        {% endif %}
        {% if step.personal %}
            {% if user.is_anonymous %}
            <i class="fa fa-lock"></i>
            {% else %}
            <i class="fa {% if step.user == request.user %}fa-lock{% else %}fa-flag{% endif %}"></i>
            {% endif %}
            {% if request.user in object.sharewith or request.user == step.user %}
                <b>[{{step.not_funded_hours|floatformat:1}} h]</b> <a href="{% url "step-detail" step.pk %}?lang={{ request.LANGUAGE_CODE }}">{{step.name}}</a>
                <p>{{step.objective|markdown|truncatewords_html:35}}</p>
            {% else %}
                <a href="{% url "step-detail" step.pk %}?lang={{ request.LANGUAGE_CODE }}">{% trans "Private" %} {% trans "step" %}.</a>
                <p>{% trans "Request access:" %} [<a href="{% url 'user-detail' object.user.username %}">{{step.user.username}}</a>]</p>
            {% endif %}
        {% else %}
            <b>[{{step.not_funded_hours|floatformat:1}} h]</b> <a href="{% url "step-detail" step.pk %}?lang={{ request.LANGUAGE_CODE }}">{{step.name}}</a> 
            <p>{{step.objective|markdown|truncatewords_html:35}}</p>
        {% endif %}

        </li>
        {% endfor %}
    </ul>
    <a href="{% url "step-create" object.pk %}">{% trans "+New Step" %}</a>
</div>
</div>

{# Include comment list with transactions #}
{% include "comment/list.html" %}

{% endblock content %}
